package main

import (
	"encoding/binary"
	"encoding/json"
	"errors"
	"fmt"
	"io/ioutil"
	"os"
	"path"
	"strings"

	"github.com/fractal-platform/fractal/common"
	"github.com/fractal-platform/fractal/common/hexutil"
	"github.com/fractal-platform/fractal/core/state"
	"github.com/fractal-platform/fractal/core/types"
	"github.com/fractal-platform/fractal/crypto"
	"github.com/fractal-platform/fractal/keys"
	"github.com/fractal-platform/fractal/params"
	"github.com/fractal-platform/fractal/utils"
	"gopkg.in/urfave/cli.v1"
)

const (
	MiningKeyContractCode           = "0x0061736d0100000001570f60000060027f7f0060057e7f7f7f7f0060057e7f7f7f7f017f60037e7f7f017f60037e7f7f0060037f7f7f017f6000017f60027f7f017f60027f7e0060017f017f60017f0060017e0060037f7f7f0060047f7f7f7f000287021003656e760864625f73746f7265000203656e760764625f6c6f6164000303656e760a64625f6861735f6b6579000403656e760d64625f72656d6f76655f6b6579000503656e76066d656d736574000603656e76086765745f66726f6d000103656e76066765745f746f000103656e76096765745f6f776e6572000103656e76087072696e74686578000103656e760a66746c5f617373657274000103656e76066d656d637079000603656e7610616374696f6e5f646174615f73697a65000703656e7610726561645f616374696f6e5f64617461000803656e760561626f7274000003656e760f66746c5f6173736572745f636f6465000903656e76076d656d6d6f76650006031b1a000a080a0b0b0708060a0a0b0b080801010b0c010a08010d0e010405017001020205030100010616037f014180c0000b7f0041e682010b7f0041e682010b07ad010c066d656d6f72790200056170706c7900220b5f5f686561705f6261736503010a5f5f646174615f656e640302055f5a6e776a0019055f5a6e616a001a065f5a646c5076001b065f5a64615076001c145f5a6e776a53743131616c69676e5f76616c5f74001d145f5a6e616a53743131616c69676e5f76616c5f74001e155f5a646c507653743131616c69676e5f76616c5f74001f155f5a6461507653743131616c69676e5f76616c5f7400200907010041010b01230a852e1a02000b0a004188c000200010120bd404010c7f02402001450d00024020002802c04122020d0041102102200041c0c1006a41103602000b200141086a200141046a41077122036b200120031b210302400240024020002802c441220420024f0d0020002004410c6c6a4180c0006a2101024020040d0020004184c0006a22022802000d0020014180c000360200200220003602000b200341046a2104034002402001280208220220046a20012802004b0d00200128020420026a2202200228020041808080807871200372360200200141086a2201200128020020046a3602002002200228020041808080807872360200200241046a22010d030b2000101322010d000b0b41fcffffff0720036b2105200041c8c1006a2106200041c0c1006a210720002802c841220821020340024020002002410c6c6a22014188c0006a28020020014180c0006a2209280200460d00410041e0810110090b20014184c0006a280200220a41046a21020340200a20092802006a210b2002417c6a220c280200220d41ffffffff077121010240200d4100480d000240200120034f0d000340200220016a2204200b4f0d01200428020022044100480d012001200441ffffffff07716a41046a22012003490d000b0b200c2001200320012003491b200d41808080807871723602000240200120034d0d00200220036a200520016a41ffffffff07713602000b200120034f0d040b200220016a41046a2202200b490d000b4100210120064100200628020041016a220220022007280200461b220236020020022008470d000b0b20010f0b200c200c2802004180808080787236020020020f0b41000b940401087f20002802c44121010240024041002d008040450d0041002802844021020c010b3f002103410041013a008040410020034110742202360284400b2002210302400240200241ffff036a41107622043f0022054d0d00417f2103200420056b4000417f460d0141002802844021030b4100200336028440200221030b2001410c6c210202400240200341ffff037122044180f8034b0d002003418080046a20046b21040c010b2003418080086a200341ffff07716b21040b200020026a2102200420036b2103024041002d0080400d003f002104410041013a00804041002004411074360284400b20024180c0006a21020240024020034100480d00410028028440220521040240200341076a417871220620056a41ffff036a41107622073f0022084d0d00417f2104200720086b4000417f460d0241002802844021040b4100200420066a36028440200521040c010b417f21040b024020002001410c6c6a22054184c0006a2802002206200228020022016a2004460d000240200120054188c0006a22072802002205460d00200620056a2206200628020041808080807871417c20056b20016a72360200200720022802003602002006200628020041ffffffff07713602000b200041c4c1006a2202200228020041016a220236020020002002410c6c6a22004180c0006a2202200336020020004184c0006a200436020020020f0b2002200120036a36020020020b7c01037f024002402000450d0041002802c8810122014101480d004188800121022001410c6c418880016a21030340200241046a2802002201450d010240200141046a20004b0d00200120022802006a20004b0d030b2002410c6a22022003490d000b0b0f0b2000417c6a2202200228020041ffffffff07713602000b02000b060041d481010bf50101067f4100210202400240410020006b22032000712000470d00200041104b0d01200110110f0b1016411636020041000f0b0240024002402000417f6a220420016a10112200450d002000200420006a2003712202460d012000417c6a220328020022044107712201450d02200020044178716a220441786a2205280200210620032001200220006b2207723602002002417c6a200420026b2203200172360200200241786a2006410771220120077236020020052001200372360200200010140b20020f0b20000f0b200241786a200041786a280200200220006b22006a3602002002417c6a200328020020006b36020020020b3301017f411621030240024020014104490d002001200210172201450d0120002001360200410021030b20030f0b10162802000b3901027f02402000410120001b2201101122000d0003404100210041002802dc81012202450d012002110000200110112200450d000b0b20000b0600200010190b0e0002402000450d00200010140b0b06002000101b0b6c01027f230041106b2202240002402002410c6a20014104200141044b1b22012000410120001b22031018450d000240034041002802dc81012200450d0120001100002002410c6a2001200310180d000c020b0b2002410036020c0b200228020c2100200241106a240020000b080020002001101d0b0e0002402000450d00200010140b0b080020002001101f0b0500100d000b4901017f230041106b22012400101002402000428080808080afc1d942520d002001410036020c2001410136020820012001290308370300200110241a0b41001015200141106a24000b4601017f230041306b22022400200241186a4100411410041a200241186a411410052002200136020c2002200241186a360208200241106a200241086a1026200241306a24000ba10502077f017e230041f0006b2201210220012400200028020421032000280200210441002105410021000240100b2206450d00024002402006418104490d002006101121000c010b20012006410f6a4170716b220024000b20002006100c1a0b200241003602382002420037033020022000360224200220003602202002200020066a360228200241206a200241306a10251a200241086a2201200228022836020020022002290320370300200241c0006a41086a20012802002201360200200241d0006a41086a2207200136020020022002290300220837035020022008370340200241e0006a41086a20072802002201360200200241106a41086a2001360200200220022903502208370310200220083703602002410036025820024200370350024002400240200228023420022802306b2201450d002001417f4c0d01200241d8006a20011019220520016a36020020022005360250200220053602542002280234200228023022076b22014101480d00200520072001100a1a2002200228025420016a22053602540b200241106a20034101756a210102402003410171450d00200128020020046a28020021040b20024100360268200242003703600240200520022802506b2205450d002005417f4c0d02200241e8006a20051019220320056a36020020022003360260200220033602642002280254200228025022076b22054101480d00200320072005100a1a2002200320056a3602640b2001200241e0006a2004110100024020022802602205450d00200220053602642005101b0b024020022802502205450d00200220053602542005101b0b02402006418104490d00200010140b024020022802302200450d00200220003602342000101b0b200241f0006a240041010f0b200241d0006a1021000b200241e0006a1021000bb80203017f017e047f2000280204210242002103200041086a2104200041046a2105410021060340024020022004280200490d00410041dd82011009200528020021020b20022d000021072005200241016a22023602002003200741ff0071200641ff0171220674ad842103200641076a2106200221022007418001710d000b02400240024020012802042205200128020022076b22062003a722024f0d002001200220066b102920012802002207200141046a2802002205470d010c020b0240200620024d0d00200141046a200720026a22053602000b20072005460d010b200041046a22062802002102200041086a21040340024020042802002002470d00410041e182011009200628020021020b200720024101100a1a2006200628020041016a22023602002005200741016a2207470d000b0b20000ba00e03077f017e027f230041b0016b22022400410021032002220441e0006a4100411410041a200441fc006a410036020020044200370274200441e0006a41086a2001280200220541086a290000370300200441e0006a41106a200541106a2800003602002004200529000037036002400240200441e0006a41146a220620012802042201460d002006200128020020012802041027200441f8006a210720042802742103200428027821050c010b200441f8006a2107410021050b200520036b2208ad2109411421010340200141016a2101200942078822094200520d000b024002402001200820016a20032005461b2208418104490d0020081011210a0c010b20022008410f6a4170716b220a24000b20044198016a41106a2201200441e0006a41106a28020036020020044198016a41086a2203200441e0006a41086a2903003703002004200429036037039801200441386a41106a2001280200360200200441386a41086a200329030037030020042004290398013703380240200841004a0d00410041b6820110090b200a200441386a4101100a1a200a41016a2101200441386a410172210302402008417f6a41014e0d00410041b6820110090b200120034101100a1a200a41026a2101200441386a410272210302402008417e6a41004a0d00410041b6820110090b200120034101100a1a200a41036a2101200441386a410372210302402008417d6a41004a0d00410041b6820110090b200120034101100a1a200a41046a2101200441386a410472210302402008417c6a41004a0d00410041b6820110090b200120034101100a1a200a41056a2101200441386a410572210302402008417b6a41004a0d00410041b6820110090b200120034101100a1a200a41066a2101200441386a410672210302402008417a6a41004a0d00410041b6820110090b200120034101100a1a200a41076a2101200441386a41077221030240200841796a41004a0d00410041b6820110090b200120034101100a1a200a41086a2101200441386a41086a21030240200841786a41004a0d00410041b6820110090b200120034101100a1a200a41096a2101200441386a41096a21030240200841776a41004a0d00410041b6820110090b200120034101100a1a200a410a6a2101200441386a410a6a21030240200841766a41004a0d00410041b6820110090b200120034101100a1a200a410b6a2101200441386a410b6a21030240200841756a41004a0d00410041b6820110090b200120034101100a1a200a410c6a2101200441386a410c6a21030240200841746a41004a0d00410041b6820110090b200120034101100a1a200a410d6a2101200441386a410d6a21030240200841736a41004a0d00410041b6820110090b200120034101100a1a200a410e6a2101200441386a410e6a21030240200841726a41004a0d00410041b6820110090b200120034101100a1a200a410f6a2101200441386a410f6a21030240200841716a41004a0d00410041b6820110090b200120034101100a1a200a41106a2101200441386a41106a21030240200841706a41004a0d00410041b6820110090b200120034101100a1a200a41116a2101200441386a41116a210302402008416f6a41004a0d00410041b6820110090b200120034101100a1a200a41126a2101200441386a41126a210302402008416e6a41004a0d00410041b6820110090b200120034101100a1a200a41136a2101200441386a41136a210302402008416d6a41004a0d00410041b6820110090b200a20086a2102200120034101100a1a200a41146a2101200441f8006a280200200441e0006a41146a2802006bad210903402009a721032004200942078822094200522205410774200341ff0071723a00380240200220016b41004a0d00410041b6820110090b2001200441386a4101100a1a200141016a210120050d000b02402006280200220b20072802002203460d002003200b6b2107410021030340200b20036a210502402002200120036a22066b41004c0d00200620054101100a1a2007200341016a2203470d010c020b410041b682011009200620054101100a1a2007200341016a2203470d000b0b200441206a41106a2201200441e0006a41106a280200360200200441206a41086a2203200441e0006a41086a2903003703002004200429036037032020044180016a41106a2001280200220136020020044180016a41086a2003290300220937030020044198016a41086a200937030020044198016a41106a2001360200200441086a41086a2009370300200441086a41106a2001360200200441003a003820042004290320220937039801200420093703800120042009370308200441386a200441386a4101722201200441386a200441086a102842808080f095f8aad3937f200120042d0038200a2008100002402008418104490d00200a10140b0240200441f4006a2802002201450d00200441f8006a20013602002001101b0b200441b0016a24000bae0201057f0240024002400240200220016b220320002802082204200028020022056b4d0d0002402005450d00200020053602042005101b41002104200041086a4100360200200042003702000b2003417f4c0d0341ffffffff0721020240200441feffffff034b0d0020032004410174220520052003491b21020b200020021019220536020020002005360204200041086a200520026a360200200520012003100a1a200041046a2101200028020420036a21000c010b02402001200028020420056b22046a2002200320044b1b220620016b2207450d00200520012007100f1a0b200041046a21010240200320044d0d00200220066b22004101480d02200128020020062000100a1a200128020020006a21000c010b200520076a21000b200120003602000b0f0b20001021000beb0301027f230041306b22042400200220022d000041146a22053a00000240200541ff01714121490d00410041bc820110090b200441106a2202200341106a280000360200200441086a2205200341086a29000037030020042003290000370300200441186a41106a22032002280200360200200441186a41086a22022005290300370300200420042903003703182001200441186a4101100a1a200141016a200441186a4101724101100a1a200141026a200441186a4102724101100a1a200141036a200441186a4103724101100a1a200141046a200441186a4104724101100a1a200141056a200441186a4105724101100a1a200141066a200441186a4106724101100a1a200141076a200441186a4107724101100a1a200141086a20024101100a1a200141096a200441186a41096a4101100a1a2001410a6a200441186a410a6a4101100a1a2001410b6a200441186a410b6a4101100a1a2001410c6a200441186a410c6a4101100a1a2001410d6a200441186a410d6a4101100a1a2001410e6a200441186a410e6a4101100a1a2001410f6a200441186a410f6a4101100a1a200141106a20034101100a1a200141116a200441186a41116a4101100a1a200141126a200441186a41126a4101100a1a200141136a200441186a41136a4101100a1a200441306a24000bbe0201067f0240024002400240024020002802082202200028020422036b20014f0d002003200028020022046b220520016a2206417f4c0d0241ffffffff0721070240200220046b220241feffffff034b0d0020062002410174220220022006491b2207450d020b2007101921020c030b200041046a21000340200341003a00002000200028020041016a22033602002001417f6a22010d000c040b0b41002107410021020c010b20001021000b200220076a2107200320016a20046b2104200220056a220521030340200341003a0000200341016a21032001417f6a22010d000b200220046a21042005200041046a2206280200200028020022016b22036b2102024020034101480d00200220012003100a1a200028020021010b2000200236020020062004360200200041086a20073602002001450d002001101b0f0b0b0bb301060041e081010b566d616c6c6f635f66726f6d5f6672656564207761732064657369676e656420746f206f6e6c792062652063616c6c6564206166746572205f686561702077617320636f6d706c6574656c7920616c6c6f6361746564000041b682010b067772697465000041bc82010b216b65792073697a65206d75737420626520736d616c6c6572207468616e203332000041dd82010b04676574000041e182010b0572656164000041000b0468410000"
	PackerKeyContractCode           = "0x0061736d01000000018f011760000060027f7f0060057f7f7f7f7f0060057e7f7f7f7f0060057e7f7f7f7f017f60037e7f7f017f60037e7f7f0060037f7f7f017f6000017f60027f7f017f60017f0060027f7e0060027f7d0060057f7e7e7e7e0060027f7c0060047e7e7e7e017f60027e7e017c60027e7e017d60027e7e017f60017f017f60087f7f7f7f7f7f7f7f0060017e0060037f7f7f0002bf042303656e760864625f73746f7265000303656e760764625f6c6f6164000403656e760a64625f6861735f6b6579000503656e760d64625f72656d6f76655f6b6579000603656e76066d656d736574000703656e76086765745f66726f6d000103656e76066765745f746f000103656e76096765745f6f776e6572000103656e76087072696e74686578000103656e760a66746c5f617373657274000103656e76066d656d637079000703656e7610616374696f6e5f646174615f73697a65000803656e7610726561645f616374696f6e5f64617461000903656e760561626f7274000003656e76067072696e7473000a03656e760f66746c5f6173736572745f636f6465000b03656e76076d656d6d6f7665000703656e760d5f5f657874656e647366746632000c03656e760b5f5f666c6f617473697466000103656e76085f5f6d756c746633000d03656e760d5f5f666c6f6174756e73697466000103656e76085f5f646976746633000d03656e76085f5f616464746633000d03656e760d5f5f657874656e646466746632000e03656e76075f5f6571746632000f03656e76075f5f6c65746632000f03656e76075f5f6e65746632000f03656e76085f5f737562746633000d03656e760c5f5f7472756e637466646632001003656e76075f5f6765746632000f03656e760c5f5f7472756e637466736632001103656e76087072696e74735f6c000103656e760a5f5f756e6f7264746632000f03656e760c5f5f666978756e7374667369001203656e76095f5f666978746673690012032b2a001309130a0a08090713130a0a090901010a090914010a150213011301011601160109090909090101020405017001030305030100010616037f014180c0000b7f0041a284010b7f0041a284010b07ad010c066d656d6f72790200056170706c79003a0b5f5f686561705f6261736503010a5f5f646174615f656e640302055f5a6e776a002c055f5a6e616a002d065f5a646c5076002e065f5a64615076002f145f5a6e776a53743131616c69676e5f76616c5f740030145f5a6e616a53743131616c69676e5f76616c5f740031155f5a646c507653743131616c69676e5f76616c5f740032155f5a6461507653743131616c69676e5f76616c5f7400330908010041010b023b3d0af44b2a02000b0a004188c000200010250bd404010c7f02402001450d00024020002802c04122020d0041102102200041c0c1006a41103602000b200141086a200141046a41077122036b200120031b210302400240024020002802c441220420024f0d0020002004410c6c6a4180c0006a2101024020040d0020004184c0006a22022802000d0020014180c000360200200220003602000b200341046a2104034002402001280208220220046a20012802004b0d00200128020420026a2202200228020041808080807871200372360200200141086a2201200128020020046a3602002002200228020041808080807872360200200241046a22010d030b2000102622010d000b0b41fcffffff0720036b2105200041c8c1006a2106200041c0c1006a210720002802c841220821020340024020002002410c6c6a22014188c0006a28020020014180c0006a2209280200460d00410041e0810110090b20014184c0006a280200220a41046a21020340200a20092802006a210b2002417c6a220c280200220d41ffffffff077121010240200d4100480d000240200120034f0d000340200220016a2204200b4f0d01200428020022044100480d012001200441ffffffff07716a41046a22012003490d000b0b200c2001200320012003491b200d41808080807871723602000240200120034d0d00200220036a200520016a41ffffffff07713602000b200120034f0d040b200220016a41046a2202200b490d000b4100210120064100200628020041016a220220022007280200461b220236020020022008470d000b0b20010f0b200c200c2802004180808080787236020020020f0b41000b940401087f20002802c44121010240024041002d008040450d0041002802844021020c010b3f002103410041013a008040410020034110742202360284400b2002210302400240200241ffff036a41107622043f0022054d0d00417f2103200420056b4000417f460d0141002802844021030b4100200336028440200221030b2001410c6c210202400240200341ffff037122044180f8034b0d002003418080046a20046b21040c010b2003418080086a200341ffff07716b21040b200020026a2102200420036b2103024041002d0080400d003f002104410041013a00804041002004411074360284400b20024180c0006a21020240024020034100480d00410028028440220521040240200341076a417871220620056a41ffff036a41107622073f0022084d0d00417f2104200720086b4000417f460d0241002802844021040b4100200420066a36028440200521040c010b417f21040b024020002001410c6c6a22054184c0006a2802002206200228020022016a2004460d000240200120054188c0006a22072802002205460d00200620056a2206200628020041808080807871417c20056b20016a72360200200720022802003602002006200628020041ffffffff07713602000b200041c4c1006a2202200228020041016a220236020020002002410c6c6a22004180c0006a2202200336020020004184c0006a200436020020020f0b2002200120036a36020020020b7c01037f024002402000450d0041002802c8810122014101480d004188800121022001410c6c418880016a21030340200241046a2802002201450d010240200141046a20004b0d00200120022802006a20004b0d030b2002410c6a22022003490d000b0b0f0b2000417c6a2202200228020041ffffffff07713602000b02000b060041d481010bf50101067f4100210202400240410020006b22032000712000470d00200041104b0d01200110240f0b1029411636020041000f0b0240024002402000417f6a220420016a10242200450d002000200420006a2003712202460d012000417c6a220328020022044107712201450d02200020044178716a220441786a2205280200210620032001200220006b2207723602002002417c6a200420026b2203200172360200200241786a2006410771220120077236020020052001200372360200200010270b20020f0b20000f0b200241786a200041786a280200200220006b22006a3602002002417c6a200328020020006b36020020020b3301017f411621030240024020014104490d0020012002102a2201450d0120002001360200410021030b20030f0b10292802000b3901027f02402000410120001b2201102422000d0003404100210041002802dc81012202450d012002110000200110242200450d000b0b20000b06002000102c0b0e0002402000450d00200010270b0b06002000102e0b6c01027f230041106b2202240002402002410c6a20014104200141044b1b22012000410120001b2203102b450d000240034041002802dc81012200450d0120001100002002410c6a20012003102b0d000c020b0b2002410036020c0b200228020c2100200241106a240020000b08002000200110300b0e0002402000450d00200010270b0b08002000200110320b0500100d000bc20101037f20004200370200200041086a22024100360200024020012d00004101710d00200020012902003702002002200141086a28020036020020000f0b02402001280204220241704f0d0020012802082103024002402002410b4f0d00200020024101743a0000200041016a210120020d01200120026a41003a000020000f0b200241106a4170712204102c21012000200441017236020020002001360208200020023602040b200120032002100a1a200120026a41003a000020000f0b100d000bf90101067f024002400240024020002001460d00200128020420012d00002202410176200241017122031b2102200141016a210420012802082105410a2101024020002d000022064101712207450d002000280200417e71417f6a21010b2005200420031b2103024002400240200220014d0d0020070d01200641017621040c020b20070d03200041016a210120020d040c050b200028020421040b20002001200220016b2004410020042002200310370b20000f0b200028020821012002450d010b20012003200210101a0b200120026a41003a0000024020002d00004101710d00200020024101743a000020000f0b2000200236020420000b860201037f0240416e20016b2002490d0002400240024020002d00004101710d00200041016a2108416f2109200141e6ffffff074d0d010c020b20002802082108416f2109200141e6ffffff074b0d010b410b21092001410174220a200220016a22022002200a491b2202410b490d00200241106a41707121090b2009102c210202402004450d00200220082004100a1a0b02402006450d00200220046a20072006100a1a0b0240200320056b220320046b2207450d00200220046a20066a200820046a20056a2007100a1a0b02402001410a460d002008102e0b20002002360208200020094101723602002000200320066a2204360204200220046a41003a00000f0b100d000bf00201077f0240024002400240200141704f0d000240024020002d000022024101710d0020024101762103410a21040c010b20002802002202417e71417f6a2104200028020421030b410a2105024020032001200320014b1b2201410b490d00200141106a417071417f6a21050b02400240024020052004460d0002402005410a470d0041012106200041016a210120002802082104410021074101210820024101710d030c050b200541016a102c2101200520044b0d0120010d010b0f0b024020002d000022024101710d0041012107200041016a210441002106410121082002410171450d030c010b200028020821044101210641012107410121082002410171450d020b200028020441016a2202450d030c020b100d000b200241fe017120087641016a2202450d010b200120042002100a1a0b02402006450d002004102e0b02402007450d0020002003360204200020013602082000200541016a4101723602000f0b200020034101743a00000b0500100d000b7e01017f230041206b220124001023024002402000428080c0d7a095abd1ca00510d002000428080808080afc1d942520d012001410036021c20014101360218200120012903183703002001103c1a0c010b200141003602142001410236021020012001290310370308200141086a103e1a0b41001028200141206a24000ba40601017f230041e0006b220524002005200136021c41b68201100e200541086a4100411410041a200541086a41141007200541286a4100411410041a200541286a411410050240024020052d000820052d0028470d0020052d000920052d0029470d0020052d000a20052d002a470d0020052d000b20052d002b470d0020052d000c20052d002c470d0020052d000d20052d002d470d0020052d000e20052d002e470d0020052d000f20052d002f470d0020052d001020052d0030470d0020052d001120052d0031470d0020052d001220052d0032470d0020052d001320052d0033470d0020052d001420052d0034470d0020052d001520052d0035470d0020052d001620052d0036470d0020052d001720052d0037470d0020052d001820052d0038470d0020052d001920052d0039470d0020052d001a20052d003a470d0020052d001b20052d003b460d010b410041ca820110090b0240200428020420042802006b41c100460d00410041ed820110090b200528021c2101200541043a002820052001360250200541286a4101722201200541d0006a4104100a1a0240428080c0d7e0abc1c8a97f200120052d002810020d00200541013a0028200541003a00502001200541d0006a4101100a1a0240428080eaf7f0abc1c8a97f200120052d00281002450d00200541286a2005410010412005200528022c41016a360254200541003a0050200541206a200541d0006a4101100a1a200541206a410172200541d0006a4104724104100a1a20052d00502101200541013a0028200520013a0058200541286a4101722201200541d8006a4101100a1a428080eaf7f0abc1c8a97f200120052d0028200541206a410510000c010b20054101360254200541003a0050200541206a200541d0006a4101100a1a200541206a410172200541d0006a4104724104100a1a20052d00502101200541013a0028200520013a0058200541286a4101722201200541d8006a4101100a1a428080eaf7f0abc1c8a97f200120052d0028200541206a410510000b2005200236022c200520033602302005200436023420052005411c6a360228200541d0006a200541286a1042200541e0006a24000bc30302047f017e230041a0016b22012400200122022000290200370368410021000240100b2203450d00024002402003418104490d002003102421000c010b20012003410f6a4170716b220024000b20002003100c1a0b200241386a41086a420037030020024200370338200241c8006a4100411410041a200241e4006a41003602002002420037025c2002200036022c200220003602282002200020036a3602302002200241286a360280012002200241386a3602900120024190016a20024180016a103f200241086a41086a2201200228023036020020022002290328370308200241f0006a41086a2001280200220136020020024180016a41086a22042001360200200220022903082205370380012002200537037020024190016a41086a20042802002201360200200241186a41086a20013602002002200229038001220537031820022005370390012002200241e8006a360294012002200241186a3602900120024190016a200241386a104002402003418104490d00200010270b0240200241dc006a2802002200450d00200241e0006a20003602002000102e0b024020022d003c410171450d00200241c4006a280200102e0b200241a0016a240041010bdf0401027f230041e0006b2202240041c08301100e200241086a4100411410041a200241086a41141007200241286a4100411410041a200241286a411410050240024020022d000820022d0028470d0020022d000920022d0029470d0020022d000a20022d002a470d0020022d000b20022d002b470d0020022d000c20022d002c470d0020022d000d20022d002d470d0020022d000e20022d002e470d0020022d000f20022d002f470d0020022d001020022d0030470d0020022d001120022d0031470d0020022d001220022d0032470d0020022d001320022d0033470d0020022d001420022d0034470d0020022d001520022d0035470d0020022d001620022d0036470d0020022d001720022d0037470d0020022d001820022d0038470d0020022d001920022d0039470d0020022d001a20022d003a470d0020022d001b20022d003b460d010b410041d8830110090b200241043a002820022001360250200241286a4101722203200241d0006a4104100a1a0240428080c0d7e0abc1c8a97f200320022d00281002450d00200241043a0028200220013602502003200241d0006a4104100a1a428080c0d7e0abc1c8a97f200320022d00281003200241286a2002410010410240200228022c22030d00410041fb830110090b20022003417f6a360254200241003a0050200241206a200241d0006a4101100a1a200241206a410172200241d0006a4104724104100a1a20022d00502103200241013a0028200220033a0058200241286a4101722203200241d8006a4101100a1a428080eaf7f0abc1c8a97f200320022d0028200241206a410510000b200241e0006a24000bea0101067f230041206b22012102200124002000280204210320002802002104410021000240100b2205450d00024002402005418104490d002005102421000c010b20012005410f6a4170716b220024000b20002005100c1a0b20024100360218200020056a21010240200541034b0d00410041bb830110090b200241186a20004104100a1a2002200041046a36020c2002200036020820022001360210200241086a20034101756a21012002280218210602402003410171450d00200128020020046a28020021040b20012006200411010002402005418104490d00200010270b200241206a240041010be10101067f20002802002102024020012802002203280208200328020422046b41034b0d00410041bb83011009200341046a28020021040b200220044104100a1a200341046a2203200328020041046a36020020012802002000280200220541046a10471a200541106a2106200128020022022802042103200241086a2107410021000340200620006a2104024020072802002003470d00410041bb83011009200241046a28020021030b200420034101100a1a200241046a2203200328020041016a2203360200200041016a22004114470d000b2001280200200541246a10481a0bc60201077f230041d0006b2202240020012802002103200241c0006a200141046a10352104200241286a41106a2205200141206a280000360200200241286a41086a2206200141186a29000037030020024200370318200241003602202002200129001037032802400240200141286a28020020012802246b2207450d002007417f4c0d01200241206a2007102c220820076a360200200220083602182002200836021c200141286a280200200141246a28020022076b22014101480d00200820072001100a1a2002200228021c20016a36021c0b200241106a2005280200360200200241086a2006290300370300200220022903283703002000200320042002200241186a104c024020022802182201450d002002200136021c2001102e0b024020042d0000410171450d002004280208102e0b200241d0006a24000f0b200241186a1039000b8c0201057f230041306b220324002003220441013a0008200420023a0000200441086a410172220520044101100a1a024002400240428080eaf7f0abc1c8a97f200520042d00084100410010012202417f4c0d0020024181044f0d0120032002410f6a4170716b22032400410021060c020b410041a0830110090b200210242103410121060b428080eaf7f0abc1c8a97f200520042d00082003200210011a200320021008200441003a0000024020020d00410041bb830110090b20044104722105200420034101100a1a200341016a210702402002417f6a41034b0d00410041bb830110090b200520074104100a1a02402006450d00200310270b20002004290300370200200441306a24000ba60403067f017e017f230041f0006b220224002002220341386a41047222044100411410041a41182105200341386a41186a22064200370300200341d8006a4200370300200341e0006a420037030020032001280200280200360238200341dc006a200128020410361a200341c4006a2001280208220741086a290000370200200341386a41146a200741106a2800003602002003200729000037023c02402006200128020c2201460d0020062001280200200128020410430b200341d4006a2802002201200628020022066b2207ad21080340200541016a2105200842078822084200520d000b200341e0006a280200200341dc006a2d0000220941017620094101711b22092005200720056a20062001461b6a21052009ad21080340200541016a2105200842078822084200520d000b024002402005418104490d002005102421010c010b20022005410f6a4170716b220124000b2003200136022c200320013602282003200120056a3602302003200341286a360268200320043602042003200341386a3602002003200341e8006a104420032802382106200341043a00002003200636026820034101722206200341e8006a4104100a1a428080c0d7e0abc1c8a97f200620032d000020012005100002402005418104490d00200110270b0240200341dc006a2d0000410171450d00200341e4006a280200102e0b0240200341d0006a2802002205450d00200341d4006a20053602002005102e0b200341f0006a24000bae0201057f0240024002400240200220016b220320002802082204200028020022056b4d0d0002402005450d00200020053602042005102e41002104200041086a4100360200200042003702000b2003417f4c0d0341ffffffff0721020240200441feffffff034b0d0020032004410174220520052003491b21020b20002002102c220536020020002005360204200041086a200520026a360200200520012003100a1a200041046a2101200028020420036a21000c010b02402001200028020420056b22046a2002200320044b1b220620016b2207450d0020052001200710101a0b200041046a21010240200320044d0d00200220066b22004101480d02200128020020062000100a1a200128020020006a21000c010b200520076a21000b200120003602000b0f0b20001039000bc00201047f230041306b2202240020002802002103024020012802002204280208200428020422056b41034a0d004100419a83011009200441046a28020021050b200520034104100a1a200441046a2204200428020041046a36020020012802002101200241106a22042000280204220341106a280000360200200241086a2200200341086a29000037030020022003290000370300200241186a41106a2004280200360200200241186a41086a20002903003703002002200229030037031820012802042104410021000340200241186a20006a21050240200141086a28020020046b41004a0d004100419a83011009200141046a28020021040b200420054101100a1a200141046a2204200428020041016a2204360200200041016a22004114470d000b2001200341146a10451a2001200341206a10461a200241306a24000b890203017f017e057f230041106b22022400200128020420012802006bad210320002802042104200041086a2105200041046a210603402003a721072002200342078822034200522208410774200741ff0071723a000f0240200528020020046b41004a0d004100419a83011009200628020021040b20042002410f6a4101100a1a2006200628020041016a220436020020080d000b024020012802002206200141046a2802002208460d00200041086a2105200041046a210703400240200528020020046b41004a0d004100419a83011009200728020021040b200420064101100a1a2007200728020041016a22043602002008200641016a2206470d000b0b200241106a240020000b990203027f017e047f230041106b22022400200128020420012d0000220341017620034101711bad210420002802042103200041086a2105200041046a210603402004a721072002200442078822044200522208410774200741ff0071723a000f0240200528020020036b41004a0d004100419a83011009200628020021030b20032002410f6a4101100a1a2006200628020041016a220336020020080d000b0240200141046a28020020012d00002206410176200641017122071b2206450d002001280208200141016a20071b21070240200041086a28020020036b20064e0d004100419a83011009200041046a28020021030b200320072006100a1a200041046a2203200328020020066a3602000b200241106a240020000b9d0301067f230041206b2202240020024100360218200242003703102000200241106a10491a024002400240024002400240024002402002280214200228021022036b2204450d00200241086a410036020020024200370300200441704f0d052004410a4b0d01200220044101743a0000200241017221050c020b20012d00004101710d02200141003b0100200141086a21030c030b200441106a4170712206102c21052002200641017236020020022005360208200220043602040b20042107200521060340200620032d00003a0000200641016a2106200341016a21032007417f6a22070d000b200520046a41003a00000240024020012d00004101710d00200141003b01000c010b200128020841003a0000200141003602040b200141001038200141086a200241086a2802003602002001200229030037020020022802102203450d040c030b200128020841003a000020014100360204200141086a21030b2001410010382003410036020020014200370200200228021022030d010c020b20021034000b200220033602142003102e0b200241206a240020000bb80203017f017e047f2000280204210242002103200041086a2104200041046a2105410021060340024020022004280200490d004100419e84011009200528020021020b20022d000021072005200241016a22023602002003200741ff0071200641ff0171220674ad842103200641076a2106200221022007418001710d000b02400240024020012802042205200128020022076b22062003a722024f0d002001200220066b104b20012802002207200141046a2802002205470d010c020b0240200620024d0d00200141046a200720026a22053602000b20072005460d010b200041046a22062802002102200041086a21040340024020042802002002470d00410041bb83011009200628020021020b200720024101100a1a2006200628020041016a22023602002005200741016a2207470d000b0b20000ba10203017f017e057f2000280204210242002103200041086a2104200041046a2105410021060340024020022004280200490d004100419e84011009200528020021020b20022d000021072005200241016a22083602002003200741ff0071200641ff0171220274ad842103200241076a2106200821022007418001710d000b0240024020012802042207200128020022026b22052003a722064f0d002001200620056b104a200041046a2802002108200141046a2802002107200128020021020c010b200520064d0d00200141046a200220066a22073602000b0240200041086a28020020086b200720026b22074f0d00410041bb83011009200041046a28020021080b200220082007100a1a200041046a2202200228020020076a36020020000bbe0201067f0240024002400240024020002802082202200028020422036b20014f0d002003200028020022046b220520016a2206417f4c0d0241ffffffff0721070240200220046b220241feffffff034b0d0020062002410174220220022006491b2207450d020b2007102c21020c030b200041046a21000340200341003a00002000200028020041016a22033602002001417f6a22010d000c040b0b41002107410021020c010b20001039000b200220076a2107200320016a20046b2104200220056a220521030340200341003a0000200341016a21032001417f6a22010d000b200220046a21042005200041046a2206280200200028020022016b22036b2102024020034101480d00200220012003100a1a200028020021010b2000200236020020062004360200200041086a20073602002001450d002001102e0f0b0bbe0201067f0240024002400240024020002802082202200028020422036b20014f0d002003200028020022046b220520016a2206417f4c0d0241ffffffff0721070240200220046b220241feffffff034b0d0020062002410174220220022006491b2207450d020b2007102c21020c030b200041046a21000340200341003a00002000200028020041016a22033602002001417f6a22010d000c040b0b41002107410021020c010b20001039000b200220076a2107200320016a20046b2104200220056a220521030340200341003a0000200341016a21032001417f6a22010d000b200220046a21042005200041046a2206280200200028020022016b22036b2102024020034101480d00200220012003100a1a200028020021010b2000200236020020062004360200200041086a20073602002001450d002001102e0f0b0bef0201057f230041d0006b2205240020002802002000280204220028020422064101756a21072000280200210802402006410171450d00200728020020086a28020021080b200541c0006a200210352100200541286a41106a2206200341106a280000360200200541286a41086a2209200341086a29000037030020054200370318200541003602202005200329000037032802400240200428020420042802006b2203450d002003417f4c0d01200541206a2003102c220220036a360200200520023602182005200236021c200441046a280200200428020022036b22044101480d00200220032004100a1a2005200528021c20046a36021c0b200541106a2006280200360200200541086a2009290300370300200520052903283703002007200120002005200541186a2008110200024020052802182204450d002005200436021c2004102e0b024020002d0000410171450d002000280208102e0b200541d0006a24000f0b200541186a1039000b0b92030b0041e081010b6a6d616c6c6f635f66726f6d5f6672656564207761732064657369676e656420746f206f6e6c792062652063616c6c6564206166746572205f686561702077617320636f6d706c6574656c7920616c6c6f636174656400736574207061636b657220707562206b65790a000041ca82010b236f6e6c79206f776e65722063616e2073657420746865207061636b6572206b65792e000041ed82010b2d746865206c656e677468206f66207075626c6963206b6579206973206e6f7420657175616c20746f2036352e0000419a83010b067772697465000041a083010b1b6572726f72206765742066726f6d207072696d617279206b6579000041bb83010b0572656164000041c083010b1864656c657465207061636b657220707562206b6579730a000041d883010b236f6e6c79206f776e65722063616e20736574207468652064656c657465206b65792e000041fb83010b235468652073697a65206f662070616b63657273206973206c657373207468616e20300000419e84010b04676574000041000b0428420000"
	TransferRestrictionContractCode = "0x0061736d0100000001510e60027f7f0060057e7f7f7f7f0060057e7f7f7f7f017f60037e7f7f017f60037e7f7f0060037f7f7f017f6000017f60027f7f017f60027f7e0060000060017f017f60017f0060017e0060047f7f7f7f0002ed010e03656e760864625f73746f7265000103656e760764625f6c6f6164000203656e760a64625f6861735f6b6579000303656e760d64625f72656d6f76655f6b6579000403656e76066d656d736574000503656e76086765745f66726f6d000003656e76066765745f746f000003656e76096765745f6f776e6572000003656e76087072696e74686578000003656e760a66746c5f617373657274000003656e76066d656d637079000503656e7610616374696f6e5f646174615f73697a65000603656e7610726561645f616374696f6e5f64617461000703656e760f66746c5f6173736572745f636f64650008031211090a070a0b0b0c000a000000000d0d000d0405017001050505030100010616037f014180c0000b7f0041f382010b7f0041f382010b072d04066d656d6f72790200056170706c7900140b5f5f686561705f6261736503010a5f5f646174615f656e640302090a010041010b04151718190a8f3d1102000b0a004188c000200010100bd404010c7f02402001450d00024020002802c04122020d0041102102200041c0c1006a41103602000b200141086a200141046a41077122036b200120031b210302400240024020002802c441220420024f0d0020002004410c6c6a4180c0006a2101024020040d0020004184c0006a22022802000d0020014180c000360200200220003602000b200341046a2104034002402001280208220220046a20012802004b0d00200128020420026a2202200228020041808080807871200372360200200141086a2201200128020020046a3602002002200228020041808080807872360200200241046a22010d030b2000101122010d000b0b41fcffffff0720036b2105200041c8c1006a2106200041c0c1006a210720002802c841220821020340024020002002410c6c6a22014188c0006a28020020014180c0006a2209280200460d00410041d4810110090b20014184c0006a280200220a41046a21020340200a20092802006a210b2002417c6a220c280200220d41ffffffff077121010240200d4100480d000240200120034f0d000340200220016a2204200b4f0d01200428020022044100480d012001200441ffffffff07716a41046a22012003490d000b0b200c2001200320012003491b200d41808080807871723602000240200120034d0d00200220036a200520016a41ffffffff07713602000b200120034f0d040b200220016a41046a2202200b490d000b4100210120064100200628020041016a220220022007280200461b220236020020022008470d000b0b20010f0b200c200c2802004180808080787236020020020f0b41000b940401087f20002802c44121010240024041002d008040450d0041002802844021020c010b3f002103410041013a008040410020034110742202360284400b2002210302400240200241ffff036a41107622043f0022054d0d00417f2103200420056b4000417f460d0141002802844021030b4100200336028440200221030b2001410c6c210202400240200341ffff037122044180f8034b0d002003418080046a20046b21040c010b2003418080086a200341ffff07716b21040b200020026a2102200420036b2103024041002d0080400d003f002104410041013a00804041002004411074360284400b20024180c0006a21020240024020034100480d00410028028440220521040240200341076a417871220620056a41ffff036a41107622073f0022084d0d00417f2104200720086b4000417f460d0241002802844021040b4100200420066a36028440200521040c010b417f21040b024020002001410c6c6a22054184c0006a2802002206200228020022016a2004460d000240200120054188c0006a22072802002205460d00200620056a2206200628020041808080807871417c20056b20016a72360200200720022802003602002006200628020041ffffffff07713602000b200041c4c1006a2202200228020041016a220236020020002002410c6c6a22004180c0006a2202200336020020004184c0006a200436020020020f0b2002200120036a36020020020b7c01037f024002402000450d0041002802c8810122014101480d004188800121022001410c6c418880016a21030340200241046a2802002201450d010240200141046a20004b0d00200120022802006a20004b0d030b2002410c6a22022003490d000b0b0f0b2000417c6a2202200228020041ffffffff07713602000b02000bf80101017f230041c0006b22012400100e0240024002400240200042ffffffff90939ea932550d0020004280808080a0e4c4c7bc7f510d0120004280808080d4ecb5dcbc7f520d03200141003602242001410136022020012001290320370318200141186a10161a0c030b200042808080d0b2d7f1a932510d012000428080808091939ea932520d022001410036023c2001410236023820012001290338370300200110161a0c020b200141003602342001410336023020012001290330370308200141086a10161a0c010b2001410036022c2001410436022820012001290328370310200141106a10161a0b41001013200141c0006a24000bad0402037f017e230041a0016b22022400200241d8006a4100411410041a200241d8006a41141007200241306a4100411410041a200241306a411410050240024020022d005820022d0030470d0020022d005920022d0031470d0020022d005a20022d0032470d0020022d005b20022d0033470d0020022d005c20022d0034470d0020022d005d20022d0035470d0020022d005e20022d0036470d0020022d005f20022d0037470d0020022d006020022d0038470d0020022d006120022d0039470d0020022d006220022d003a470d0020022d006320022d003b470d0020022d006420022d003c470d0020022d006520022d003d470d0020022d006620022d003e470d0020022d006720022d003f470d0020022d006820022d0040470d0020022d006920022d0041470d0020022d006a20022d0042470d0020022d006b20022d0043460d010b410041aa820110090b200241186a41106a2203200141106a280000360200200241186a41086a2204200141086a29000037030020022001290000370318200241f0006a41106a20032802002201360200200241f0006a41086a2004290300220537030020024188016a41086a200537030020024188016a41106a2001360200200241086a2005370300200241106a2001360200200241003a0030200220022903182205370388012002200537037020022005370300200241306a200241306a4101722201200241306a2002101c428080e0cd92a3e5ae63200120022d00301003200241a0016a24000bf90902077f017e23004190016b22012102200124002000280204210320002802002104410021000240100b2205450d00024002402005418104490d002005100f21000c010b20012005410f6a4170716b220024000b20002005100c1a0b200241306a4100411410041a024020050d00410041ee820110090b200241306a20004101100a1a200041016a2101200241306a4101722106024020054101470d00410041ee820110090b200620014101100a1a200041026a2101200241306a4102722106024020054102470d00410041ee820110090b200620014101100a1a200041036a2101200241306a4103722106024020054103470d00410041ee820110090b200620014101100a1a200041046a2101200241306a4104722106024020054104470d00410041ee820110090b200620014101100a1a200041056a2101200241306a4105722106024020054105470d00410041ee820110090b200620014101100a1a200041066a2101200241306a4106722106024020054106470d00410041ee820110090b200620014101100a1a200041076a2101200241306a4107722106024020054107470d00410041ee820110090b200620014101100a1a200041086a2101200241306a41086a2106024020054108470d00410041ee820110090b200620014101100a1a200041096a2101200241306a41096a2106024020054109470d00410041ee820110090b200620014101100a1a2000410a6a2101200241306a410a6a210602402005410a470d00410041ee820110090b200620014101100a1a2000410b6a2101200241306a410b6a210602402005410b470d00410041ee820110090b200620014101100a1a2000410c6a2101200241306a410c6a210602402005410c470d00410041ee820110090b200620014101100a1a2000410d6a2101200241306a410d6a210602402005410d470d00410041ee820110090b200620014101100a1a2000410e6a2101200241306a410e6a210602402005410e470d00410041ee820110090b200620014101100a1a2000410f6a2101200241306a410f6a210602402005410f470d00410041ee820110090b200620014101100a1a200041106a2101200241306a41106a2106024020054110470d00410041ee820110090b200620014101100a1a200041116a2101200241306a41116a2106024020054111470d00410041ee820110090b200620014101100a1a200041126a2101200241306a41126a2106024020054112470d00410041ee820110090b200020056a2107200620014101100a1a200041136a2101200241306a41136a2106024020054113470d00410041ee820110090b200620014101100a1a20022007360228200220003602202002200041146a360224200241c8006a41106a2201200241306a41106a280200360200200241c8006a41086a2206200241306a41086a29030037030020022002290330370348200241e0006a41106a2001280200360200200241e0006a41086a200629030037030020022002290348370360200241206a20034101756a210102402003410171450d00200128020020046a28020021040b200241f8006a41106a200241e0006a41106a2802002203360200200241f8006a41086a200241e0006a41086a2903002208370300200241086a41086a2008370300200241086a41106a2003360200200220022903602208370308200220083703782001200241086a200411000002402005418104490d00200010120b20024190016a240041010b930602057f017e23004180026b22022400200241186a4100411410041a200241186a41141007200241a8016a4100411410041a200241a8016a411410050240024020022d001820022d00a801470d0020022d001920022d00a901470d0020022d001a20022d00aa01470d0020022d001b20022d00ab01470d0020022d001c20022d00ac01470d0020022d001d20022d00ad01470d0020022d001e20022d00ae01470d0020022d001f20022d00af01470d0020022d002020022d00b001470d0020022d002120022d00b101470d0020022d002220022d00b201470d0020022d002320022d00b301470d0020022d002420022d00b401470d0020022d002520022d00b501470d0020022d002620022d00b601470d0020022d002720022d00b701470d0020022d002820022d00b801470d0020022d002920022d00b901470d0020022d002a20022d00ba01470d0020022d002b20022d00bb01460d010b410041aa820110090b200241a8016a4100411410041a200241a8016a41146a22034100411410041a200241a8016a41106a2204200141106a2800002205360200200241a8016a41086a2206200141086a2900002207370300200241c4016a2007370200200241cc016a20053602002002200129000022073703a801200220073702bc012002200241306a41286a3602a0012002200241306a36029c012002200241306a36029801200220024198016a3602e801200220033602742002200241a8016a360270200241f0006a200241e8016a101a200241d8006a41106a22012004280200360200200241d8006a41086a22032006290300370300200220022903a801370358200241d0016a41106a20012802002201360200200241d0016a41086a20032903002207370300200241e8016a41086a2007370300200241e8016a41106a2001360200200241086a2007370300200241106a2001360200200241003a00702002200229035822073703e801200220073703d00120022007370300200241f0006a200241f0006a4101722201200241f0006a2002101b428080e0cd9283a2a63c200120022d0070200241306a4128100020024180026a24000bad0402037f017e230041a0016b22022400200241d8006a4100411410041a200241d8006a41141007200241306a4100411410041a200241306a411410050240024020022d005820022d0030470d0020022d005920022d0031470d0020022d005a20022d0032470d0020022d005b20022d0033470d0020022d005c20022d0034470d0020022d005d20022d0035470d0020022d005e20022d0036470d0020022d005f20022d0037470d0020022d006020022d0038470d0020022d006120022d0039470d0020022d006220022d003a470d0020022d006320022d003b470d0020022d006420022d003c470d0020022d006520022d003d470d0020022d006620022d003e470d0020022d006720022d003f470d0020022d006820022d0040470d0020022d006920022d0041470d0020022d006a20022d0042470d0020022d006b20022d0043460d010b410041aa820110090b200241186a41106a2203200141106a280000360200200241186a41086a2204200141086a29000037030020022001290000370318200241f0006a41106a20032802002201360200200241f0006a41086a2004290300220537030020024188016a41086a200537030020024188016a41106a2001360200200241086a2005370300200241106a2001360200200241003a0030200220022903182205370388012002200537037020022005370300200241306a200241306a4101722201200241306a2002101c428080e0cd9283a2a63c200120022d00301003200241a0016a24000b930602057f017e23004180026b22022400200241186a4100411410041a200241186a41141007200241a8016a4100411410041a200241a8016a411410050240024020022d001820022d00a801470d0020022d001920022d00a901470d0020022d001a20022d00aa01470d0020022d001b20022d00ab01470d0020022d001c20022d00ac01470d0020022d001d20022d00ad01470d0020022d001e20022d00ae01470d0020022d001f20022d00af01470d0020022d002020022d00b001470d0020022d002120022d00b101470d0020022d002220022d00b201470d0020022d002320022d00b301470d0020022d002420022d00b401470d0020022d002520022d00b501470d0020022d002620022d00b601470d0020022d002720022d00b701470d0020022d002820022d00b801470d0020022d002920022d00b901470d0020022d002a20022d00ba01470d0020022d002b20022d00bb01460d010b410041aa820110090b200241a8016a4100411410041a200241a8016a41146a22034100411410041a200241a8016a41106a2204200141106a2800002205360200200241a8016a41086a2206200141086a2900002207370300200241c4016a2007370200200241cc016a20053602002002200129000022073703a801200220073702bc012002200241306a41286a3602a0012002200241306a36029c012002200241306a36029801200220024198016a3602e801200220033602742002200241a8016a360270200241f0006a200241e8016a101d200241d8006a41106a22012004280200360200200241d8006a41086a22032006290300370300200220022903a801370358200241d0016a41106a20012802002201360200200241d0016a41086a20032903002207370300200241e8016a41086a2007370300200241e8016a41106a2001360200200241086a2007370300200241106a2001360200200241003a00702002200229035822073703e801200220073703d00120022007370300200241f0006a200241f0006a4101722201200241f0006a2002101e428080e0cd92a3e5ae63200120022d0070200241306a4128100020024180026a24000ba60301067f230041306b2202240020012802002103200241106a22042000280200220541106a280000360200200241086a2206200541086a29000037030020022005290000370300200241186a41106a2004280200360200200241186a41086a20062903003703002002200229030037031820032802042105200341046a2106410021040340200241186a20046a21070240200341086a28020020056b41004a0d00410041c782011009200628020021050b200520074101100a1a2006200628020041016a2205360200200441016a22044114470d000b200241086a22042000280204220541086a290000370300200241106a2206200541106a2800003602002002200529000037030020012802002103200241186a41106a2006280200360200200241186a41086a20042903003703002002200229030037031820032802042105200341046a2106410021040340200241186a20046a21070240200341086a28020020056b41004a0d00410041c782011009200628020021050b200520074101100a1a2006200628020041016a2205360200200441016a22044114470d000b200241306a24000beb0301027f230041306b22042400200220022d000041146a22053a00000240200541ff01714121490d00410041cd820110090b200441106a2202200341106a280000360200200441086a2205200341086a29000037030020042003290000370300200441186a41106a22032002280200360200200441186a41086a22022005290300370300200420042903003703182001200441186a4101100a1a200141016a200441186a4101724101100a1a200141026a200441186a4102724101100a1a200141036a200441186a4103724101100a1a200141046a200441186a4104724101100a1a200141056a200441186a4105724101100a1a200141066a200441186a4106724101100a1a200141076a200441186a4107724101100a1a200141086a20024101100a1a200141096a200441186a41096a4101100a1a2001410a6a200441186a410a6a4101100a1a2001410b6a200441186a410b6a4101100a1a2001410c6a200441186a410c6a4101100a1a2001410d6a200441186a410d6a4101100a1a2001410e6a200441186a410e6a4101100a1a2001410f6a200441186a410f6a4101100a1a200141106a20034101100a1a200141116a200441186a41116a4101100a1a200141126a200441186a41126a4101100a1a200141136a200441186a41136a4101100a1a200441306a24000beb0301027f230041306b22042400200220022d000041146a22053a00000240200541ff01714121490d00410041cd820110090b200441106a2202200341106a280000360200200441086a2205200341086a29000037030020042003290000370300200441186a41106a22032002280200360200200441186a41086a22022005290300370300200420042903003703182001200441186a4101100a1a200141016a200441186a4101724101100a1a200141026a200441186a4102724101100a1a200141036a200441186a4103724101100a1a200141046a200441186a4104724101100a1a200141056a200441186a4105724101100a1a200141066a200441186a4106724101100a1a200141076a200441186a4107724101100a1a200141086a20024101100a1a200141096a200441186a41096a4101100a1a2001410a6a200441186a410a6a4101100a1a2001410b6a200441186a410b6a4101100a1a2001410c6a200441186a410c6a4101100a1a2001410d6a200441186a410d6a4101100a1a2001410e6a200441186a410e6a4101100a1a2001410f6a200441186a410f6a4101100a1a200141106a20034101100a1a200141116a200441186a41116a4101100a1a200141126a200441186a41126a4101100a1a200141136a200441186a41136a4101100a1a200441306a24000ba60301067f230041306b2202240020012802002103200241106a22042000280200220541106a280000360200200241086a2206200541086a29000037030020022005290000370300200241186a41106a2004280200360200200241186a41086a20062903003703002002200229030037031820032802042105200341046a2106410021040340200241186a20046a21070240200341086a28020020056b41004a0d00410041c782011009200628020021050b200520074101100a1a2006200628020041016a2205360200200441016a22044114470d000b200241086a22042000280204220541086a290000370300200241106a2206200541106a2800003602002002200529000037030020012802002103200241186a41106a2006280200360200200241186a41086a20042903003703002002200229030037031820032802042105200341046a2106410021040340200241186a20046a21070240200341086a28020020056b41004a0d00410041c782011009200628020021050b200520074101100a1a2006200628020041016a2205360200200441016a22044114470d000b200241306a24000beb0301027f230041306b22042400200220022d000041146a22053a00000240200541ff01714121490d00410041cd820110090b200441106a2202200341106a280000360200200441086a2205200341086a29000037030020042003290000370300200441186a41106a22032002280200360200200441186a41086a22022005290300370300200420042903003703182001200441186a4101100a1a200141016a200441186a4101724101100a1a200141026a200441186a4102724101100a1a200141036a200441186a4103724101100a1a200141046a200441186a4104724101100a1a200141056a200441186a4105724101100a1a200141066a200441186a4106724101100a1a200141076a200441186a4107724101100a1a200141086a20024101100a1a200141096a200441186a41096a4101100a1a2001410a6a200441186a410a6a4101100a1a2001410b6a200441186a410b6a4101100a1a2001410c6a200441186a410c6a4101100a1a2001410d6a200441186a410d6a4101100a1a2001410e6a200441186a410e6a4101100a1a2001410f6a200441186a410f6a4101100a1a200141106a20034101100a1a200141116a200441186a41116a4101100a1a200141126a200441186a41126a4101100a1a200141136a200441186a41136a4101100a1a200441306a24000b0bc501050041d481010b736d616c6c6f635f66726f6d5f6672656564207761732064657369676e656420746f206f6e6c792062652063616c6c6564206166746572205f686561702077617320636f6d706c6574656c7920616c6c6f6361746564006f6e6c79206f776e65722063616e2073657420746865206c6973742e000041c782010b067772697465000041cd82010b216b65792073697a65206d75737420626520736d616c6c6572207468616e203332000041ee82010b0572656164000041000b0478410000"
)

var (
	gstateCommand = cli.Command{
		Name:  "gstate",
		Usage: "Manage Fractal Genesis State",
		Flags: []cli.Flag{
			PasswordFlag,
			GenesisStakeFlag,
			PackerKeyContractOwnerFlag,
			TransferRestrictionContractOwnerFlag,
		},
		Subcommands: []cli.Command{
			{
				Name:   "gen",
				Usage:  "Generate Fractal Genesis State Json",
				Action: genGenesisState,
				Flags: []cli.Flag{
					PasswordFlag,
					GenesisStakeFlag,
					PackerKeyContractOwnerFlag,
					TransferRestrictionContractOwnerFlag,
				},
			},
		},
	}
)

func genGenesisState(ctx *cli.Context) error {
	initLogger(ctx)

	password := ctx.GlobalString(PasswordFlag.Name)
	gstake := ctx.GlobalUint64(GenesisStakeFlag.Name)
	packerKeyContractOwnerAddress := ctx.GlobalString(PackerKeyContractOwnerFlag.Name)
	transferRestrictionContractOwnerAddress := ctx.GlobalString(TransferRestrictionContractOwnerFlag.Name)

	miningKeyMap := make(map[common.Address]keys.MiningPubkey)
	packerAddrSlice := make([]common.Address, 0)
	packerKeyMap := make(map[common.Address]types.PackerECPubKey)
	dirs, _ := ioutil.ReadDir(".")
	for _, dir := range dirs {
		if !dir.IsDir() {
			continue
		}

		fmt.Printf("scan folder: %s\n", dir.Name())

		miningKeyDir := path.Join(path.Join(dir.Name(), "keys"), miningKeySubFolder)
		if _, err := os.Stat(miningKeyDir); !os.IsNotExist(err) {
			keyman := keys.NewMiningKeyManager(miningKeyDir, password)
			if keyman.Load() != nil {
				return errors.New("unlock password error")
			}
			for addr, v := range keyman.Keys() {
				for pubkey := range v {
					miningKeyMap[addr] = pubkey
				}
			}
		}

		packerKeyDir := path.Join(path.Join(dir.Name(), "keys"), packerKeySubFolder)
		if _, err := os.Stat(packerKeyDir); !os.IsNotExist(err) {
			keyman := keys.NewPackerKeyManager(packerKeyDir, password)
			if keyman.Load() != nil {
				return errors.New("unlock password error")
			}
			for addr, v := range keyman.Keys() {
				for pubkey := range v {
					packerKeyMap[addr] = pubkey
				}
				packerAddrSlice = append(packerAddrSlice, addr)
			}
		}
	}
	fmt.Printf("mining key size: %d\n", len(miningKeyMap))
	fmt.Printf("packer key size: %d\n", len(packerAddrSlice))

	ipList := make([]string, 0)
	ipBytes, err := ioutil.ReadFile("./ip.list")
	if err == nil {
		ipStrs := string(ipBytes)
		lines := strings.Split(ipStrs, "\n")
		for _, line := range lines {
			line = strings.TrimSpace(line)
			if line == "" || line[0] == '#' {
				continue
			}
			ipList = append(ipList, line)
		}
	}
	fmt.Printf("ip list size: %d\n", len(ipList))

	miningKeyContract := make(map[string]interface{})
	miningKeyContract["code"] = MiningKeyContractCode
	miningKeyContract["balance"] = 0
	miningKeyContract["owner"] = params.MinerKeyContractAddr
	storageList := make([]interface{}, 0)
	for addr, pubkey := range miningKeyMap {
		storageMap := make(map[string]interface{})

		table, _ := utils.String2Uint64(params.MinerKeyContractTable)
		storageKey := state.GetStorageKey(table, addr[:])
		storageMap["Key"] = hexutil.Encode(storageKey.ToSlice())

		var value = make([]byte, 22+crypto.BlsPubkeyLen) // 20 + 2 + BlsPubkeyLen
		copy(value[:20], addr[:])
		value[20] = 0x80 // two bytes for len
		value[21] = 1    // two bytes for len
		copy(value[22:], pubkey[:])
		storageMap["Value"] = hexutil.Encode(value)

		storageList = append(storageList, storageMap)
	}
	miningKeyContract["storage"] = storageList

	packerKeyContract := make(map[string]interface{})
	packerKeyContract["code"] = PackerKeyContractCode
	packerKeyContract["balance"] = 0
	packerKeyContract["owner"] = packerKeyContractOwnerAddress
	if len(ipList) == len(packerAddrSlice) {
		storageList = make([]interface{}, 0)

		// packer info
		for i, addr := range packerAddrSlice {
			storageMap := make(map[string]interface{})

			packerKey := packerKeyMap[addr]
			rpcAddr := fmt.Sprintf("http://%s:8545", ipList[i])

			table, _ := utils.String2Uint64(params.PackerKeyContractInfoTable)
			indexByte := make([]byte, 4)
			binary.LittleEndian.PutUint32(indexByte, uint32(i))
			storageKey := state.GetStorageKey(table, indexByte)
			storageMap["Key"] = hexutil.Encode(storageKey.ToSlice())

			var value = make([]byte, 91) // 4 + 20 + 1 + 65(PackerECPubKey) + 1
			binary.LittleEndian.PutUint32(value[:4], uint32(i))
			copy(value[4:24], addr[:])
			value[24] = 65
			copy(value[25:90], packerKey[:])
			value[90] = byte(len(rpcAddr))
			value = append(value, []byte(rpcAddr)...)
			storageMap["Value"] = hexutil.Encode(value)

			storageList = append(storageList, storageMap)
		}

		// packer size
		storageMap := make(map[string]interface{})
		table, _ := utils.String2Uint64(params.PackerKeyContractSizeTable)
		storageKey := state.GetStorageKey(table, []byte{0})
		storageMap["Key"] = hexutil.Encode(storageKey.ToSlice())
		var value = make([]byte, 5)
		value[0] = 0
		binary.LittleEndian.PutUint32(value[1:5], uint32(len(packerAddrSlice)))
		storageMap["Value"] = hexutil.Encode(value)
		storageList = append(storageList, storageMap)

		// add storage
		packerKeyContract["storage"] = storageList
	}

	transferRestrictionContract := make(map[string]interface{})
	transferRestrictionContract["code"] = TransferRestrictionContractCode
	transferRestrictionContract["balance"] = 0
	transferRestrictionContract["owner"] = transferRestrictionContractOwnerAddress

	ret := make(map[string]interface{})
	ret[params.MinerKeyContractAddr] = miningKeyContract
	ret[params.PackerKeyContractAddr] = packerKeyContract
	ret[params.TransferRestrictionContractAddr] = transferRestrictionContract

	for addr := range miningKeyMap {
		addrString := hexutil.Encode(addr[:])
		addrStorage := make(map[string]interface{})
		addrStorage["balance"] = gstake / uint64(len(miningKeyMap))
		ret[addrString] = addrStorage
	}

	s, _ := json.MarshalIndent(ret, "", "    ")
	ioutil.WriteFile("genesis_alloc.json", s, 0644)

	return nil
}
